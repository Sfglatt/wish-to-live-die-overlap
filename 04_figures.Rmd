---
title: "04_figures"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
if (!require("grid")) {
  install.packages("grid")
  require("grid")
}
if (!require("VennDiagram")) {
  install.packages("VennDiagram")
  require("VennDiagram")
}
if (!require("showtext")) {
  install.packages("showtext")
  require("showtext")
}

showtext_auto()
font_add(family = "Times New Roman", regular = "times.ttf")

if (!require("ggplot2")) {
  install.packages("ggplot2")
  require("ggplot2")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("tidyr")) {
  install.packages("tidyr")
  require("tidyr")
}
if (!require("patchwork")) {
  install.packages("patchwork")
  require("patchwork")
}


# Make a folder to save the output
if (!dir.exists("04_output")) {
  dir.create("04_output")
}
```

# Venn diagram
Conceptual Figure overlap and distinctiveness between the Wish to Live and Wish to Die
```{r venn diagram}
png("04_Output/Commonality_venn.png",
  width = 5.5, height = 5, units = "in", res = 300
)

grid.newpage()

venn.plot <- draw.pairwise.venn(
  area1 = 6,
  area2 = 6,
  cross.area = 3,
  category = c("", ""),
  fill = c("#66CCFF", "#FF66CC"),
  lty = "solid",
  cex = 0,
  cat.cex = 1.5,
  cat.col = c("#3399CC", "#FF66CC")
)

grid.text("WTL (Unique)",
  x = 0.18, y = 0.50,
  gp = gpar(fontsize = 38, fontfamily = "Times New Roman")
)

grid.text("WTD (Unique)",
  x = 0.82, y = 0.50,
  gp = gpar(fontsize = 38, fontfamily = "Times New Roman")
)

grid.text("WTL and WTD (Common)",
  x = 0.51, y = 0.50,
  gp = gpar(fontsize = 38, fontfamily = "Times New Roman")
)

dev.off()
```

# Data for variance figures
```{r plot data}
# Dataset/variables created in 03_analysis.Rmd
Baseline_data <- read.csv("02_output/Baseline_data_vars_2025-12-21.csv")

# Make a theme for all plots
pub_theme <- theme_minimal(base_size = 14) +
  theme(
    text = element_text(family = "Times New Roman"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.text = element_text(color = "black", size = 14),
    axis.title.y = element_text(margin = margin(r = 10), face = "bold"),
    axis.text.x = element_text(face = "bold", margin = margin(t = 5)),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  )
```

# Visualize linear vs rank-based residuals' correlations
```{r residuals}
# WTL scatter
p1 <- ggplot(Baseline_data, aes(x = WTL_unique, y = WTL_unique_rank)) +
  geom_point(alpha = 0.6, color = "#66CCFF") +
  # geom_smooth(method = "lm", col = "#66CCFF") +
  labs(
    title = "WTL",
    x = "WTL (linear)",
    y = "WTL (rank)"
  ) +
  pub_theme

# WTD scatter
p2 <- ggplot(Baseline_data, aes(x = WTD_unique, y = WTD_unique_rank)) +
  geom_point(alpha = 0.6, color = "#FF66CC") +
  # geom_smooth(method = "lm", col = "#FF66CC") +
  labs(
    title = "WTD",
    x = "WTD (linear)",
    y = "WTD (rank)"
  ) +
  pub_theme

# Shared PCA scatter
p3 <- ggplot(Baseline_data, aes(x = WTL_WTD_shared, y = WTL_WTD_shared_rank)) +
  geom_point(alpha = 0.6, color = "mediumpurple") +
  # geom_smooth(method = "lm", col = "mediumpurple") +
  labs(
    title = "Shared Component",
    x = "Shared (linear)",
    y = "Shared (rank)"
  ) +
  pub_theme

# Combine plots
combined_plot <- (p1 | p2 | p3) +
  plot_layout(guides = "collect")

combined_plot
```

# Plot variance decomposition and absolute magnitude
```{r plots}
# Plot data
plot_data <- Baseline_data %>%
  # Residualized + shared variation
  dplyr::select(WTL_unique, WTD_unique, WTL_WTD_shared) %>%
  rename(
    `WTL Unique` = WTL_unique,
    `WTD Unique` = WTD_unique,
    `Shared Component` = WTL_WTD_shared
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  mutate(
    # Absolute values
    Abs_Value = abs(Value),
    Component = factor(Component, levels = c("WTL Unique", "Shared Component", "WTD Unique"))
  )

# Variance partitions (raw residuals)
p_decomp <- ggplot(plot_data, aes(x = Component, y = Value, fill = Component)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  geom_jitter(aes(color = Component), width = 0.15, alpha = 0.2, size = 1.2, show.legend = FALSE) +
  geom_boxplot(width = 0.4, alpha = 0.8, outlier.shape = NA, show.legend = FALSE, size = 0.3) +
  scale_fill_manual(values = c("WTL Unique" = "#66CCFF", "Shared Component" = "mediumpurple", "WTD Unique" = "#FF66CC")) +
  # Trying to match the conceptual figure overlap color
  scale_color_manual(values = c("WTL Unique" = "#66CCFF", "Shared Component" = "mediumpurple", "WTD Unique" = "#FF66CC")) +
  labs(
    x = NULL,
    y = "Component Score (Centered)"
  ) +
  pub_theme

# Absolute value (magnitude)
p_ttest <- ggplot(plot_data, aes(x = Component, y = Abs_Value, fill = Component)) +
  geom_jitter(aes(color = Component), width = 0.15, alpha = 0.2, size = 1.2, show.legend = FALSE) +
  geom_boxplot(width = 0.4, alpha = 0.8, outlier.shape = NA, show.legend = FALSE, size = 0.3) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3.5, color = "black", show.legend = FALSE) +
  scale_fill_manual(values = c("WTL Unique" = "#66CCFF", "Shared Component" = "mediumpurple", "WTD Unique" = "#FF66CC")) +
  scale_color_manual(values = c("WTL Unique" = "#66CCFF", "Shared Component" = "mediumpurple", "WTD Unique" = "#FF66CC")) +
  labs(
    x = NULL,
    y = "Absolute Magnitude (|x|)"
  ) +
  pub_theme

p_decomp
p_ttest
```

# Plot individual-level proportions
```{r individual plot}
# Make normalized absolute values
tri_norm <- Baseline_data %>%
  # Absolute values
  transmute(
    WTL    = abs(WTL_unique),
    Shared = abs(WTL_WTD_shared),
    WTD    = abs(WTD_unique)
  ) %>%
  # Proportions
  mutate(
    total = WTL + Shared + WTD,
    across(c(WTL, Shared, WTD), ~ .x / total),
    ID = row_number()
  ) %>%
  rowwise() %>%
  # Dominant component
  mutate(
    DominantComponent = names(which.max(c(WTL = WTL, Shared = Shared, WTD = WTD))),
    DominantValue = max(c(WTL, Shared, WTD))
  ) %>%
  ungroup() %>%
  arrange(
    factor(DominantComponent, levels = c("WTL", "Shared", "WTD")),
    DominantValue
  ) %>%
  mutate(plot_id = row_number())

# Label + separator data
label_data <- tri_norm %>%
  group_by(DominantComponent) %>%
  summarize(center = mean(plot_id), .groups = "drop")

line_data <- tri_norm %>%
  group_by(DominantComponent) %>%
  summarize(max_id = max(plot_id), .groups = "drop") %>%
  filter(max_id < max(tri_norm$plot_id))

# Shift to long form
tri_long <- tri_norm %>%
  select(plot_id, WTL, Shared, WTD) %>%
  pivot_longer(-plot_id,
    names_to = "Component",
    values_to = "Proportion"
  ) %>%
  mutate(Component = factor(Component, levels = c("WTL", "Shared", "WTD")))

# Plot
ggplot(tri_long, aes(plot_id, Proportion, fill = Component)) +
  geom_col(width = 1, color = "white", linewidth = 0.05) +
  geom_rug(
    data = tri_norm, aes(x = plot_id),
    sides = "b", inherit.aes = FALSE,
    alpha = 0.6, length = unit(0.02, "npc")
  ) +
  geom_vline(
    data = line_data, aes(xintercept = max_id + 0.5),
    linewidth = 0.6
  ) +
  geom_text(
    data = label_data,
    aes(x = center, y = 1.02, label = DominantComponent),
    inherit.aes = FALSE,
    fontface = "bold", size = 4,
    family = "Times New Roman"
  ) +
  scale_fill_manual(
    values = c(
      WTL = "#66CCFF",
      Shared = "mediumpurple",
      WTD = "#FF66CC"
    ),
    labels = c(
      WTL = "WTL (unique)",
      Shared = "Shared Component",
      WTD = "WTD (unique)"
    )
  ) +
  labs(x = "Individuals", y = "Proportion") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), breaks = c(0, .25, .75, 1)) +
  coord_cartesian(clip = "off") +
  pub_theme +
  theme(
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(20, 10, 10, 10)
  )
```

